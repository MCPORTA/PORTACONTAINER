<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TYPING</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#667eea">
    <link rel="icon" href="/static/pwa-icon.png">
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/static/service-worker.js');
        });
      }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }
        h1 { text-align: center; color: #333; margin-bottom: 30px; font-size: 2.5em; font-weight: 300; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #667eea; }
        .stat-value { font-size: 2em; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; font-size: 0.9em; margin-top: 5px; }
        .text-display { background: #f8f9fa; padding: 30px; border-radius: 15px; margin-bottom: 30px; font-size: 1.2em; line-height: 1.6; color: #333; border: 2px solid #e9ecef; min-height: 120px; display: flex; align-items: flex-start; flex-wrap: wrap; word-break: break-word; white-space: pre-line; }
        .text-input { width: 100%; padding: 20px; border: 2px solid #e9ecef; border-radius: 15px; font-size: 1.1em; font-family: inherit; resize: none; margin-bottom: 20px; transition: border-color 0.3s ease; }
        .text-input:focus { outline: none; border-color: #667eea; }
        .text-input:disabled { background: #f8f9fa; color: #666; }
        .controls { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 15px 30px; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a6fd8; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; transform: translateY(-2px); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; transform: translateY(-2px); }
        .results { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 15px; display: none; }
        .results.show { display: block; }
        .history { margin-top: 30px; }
        .history h3 { color: #333; margin-bottom: 15px; }
        .history-item { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .history-wpm { font-weight: bold; color: #667eea; }
        .history-precision { color: #28a745; }
        .history-date { color: #666; font-size: 0.9em; }
        .correct { color: #28a745; background: #d4edda; }
        .incorrect { color: #dc3545; background: #f8d7da; text-decoration: underline; }
        .current { background: #fff3cd; border-bottom: 2px solid #667eea; }
        @media (max-width: 768px) { .container { padding: 20px; } h1 { font-size: 2em; } .stats { grid-template-columns: 1fr 1fr; } .controls { flex-direction: column; } }
        .titulo-dinamico {
            margin: 0;
            font-size: 3.5em;
            font-weight: 800;
            letter-spacing: 4px;
            background: linear-gradient(270deg, #f9d423, #ff4e50, #a1ffce, #fbc2eb, #fad0c4, #a18cd1, #fbc2eb, #f9d423);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            text-shadow: 2px 2px 16px rgba(118,75,162,0.18), 0 4px 32px rgba(102,126,234,0.13);
            transition: transform 0.3s, text-shadow 0.3s;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            text-align: center;
            animation: acuarela-move 4s ease-in-out infinite alternate;
        }
        .titulo-dinamico:hover {
            transform: translate(-50%, -50%) scale(1.07);
            text-shadow: 4px 4px 32px rgba(118,75,162,0.25), 0 8px 48px rgba(102,126,234,0.18);
        }
        @keyframes acuarela-move {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="position: relative; margin-bottom: 30px; height: 240px;">
            <img src="/static/Logo.png" alt="Logo" style="position: absolute; left: -40px; top: -160px; height: 300px; width: 300px; object-fit: contain; display: block;" />
            <h1 class="titulo-dinamico">⚡ ¡ TYPING ! ⚡</h1>
        </div>
        <div style="margin-bottom: 20px; text-align: center;">
            <input type="text" id="nombreInput" placeholder="Escribe tu nombre" style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 60%; max-width: 300px; font-size: 1em; margin-bottom: 10px;" />
            <select id="nivelInput" style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; width: 60%; max-width: 300px; margin-top: 10px;">
                <option value="facil">Fácil</option>
                <option value="medio">Medio</option>
                <option value="dificil">Difícil</option>
            </select>
        </div>
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="wpm">0</div>
                <div class="stat-label">WPM</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="precision">0%</div>
                <div class="stat-label">Precisión</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="tiempo">0s</div>
                <div class="stat-label">Tiempo</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="caracteres">0</div>
                <div class="stat-label">Caracteres</div>
            </div>
        </div>
        <div class="text-display" id="textDisplay">
            <span id="nivelActual" style="font-weight:bold;color:#667eea;"></span>
            <span id="textoParaEscribir">Haz clic en "Comenzar" para iniciar el test de mecanografía</span>
        </div>
        <textarea class="text-input" id="textInput" placeholder="Escribe aquí el texto que aparece arriba..." disabled></textarea>
        <div class="controls">
            <button class="btn btn-primary" id="startBtn">Comenzar</button>
            <button class="btn btn-secondary" id="resetBtn">Reiniciar</button>
            <button class="btn btn-success" id="statsBtn">Ver Estadísticas</button>
        </div>
        <div class="results" id="results">
            <h3>Resultados del Test</h3>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="finalWpm">0</div>
                    <div class="stat-label">WPM Final</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="finalPrecision">0%</div>
                    <div class="stat-label">Precisión Final</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="finalTiempo">0s</div>
                    <div class="stat-label">Tiempo Total</div>
                </div>
            </div>
        </div>
        <div class="history" id="history" style="display: none;">
            <h3>Historial de Resultados</h3>
            <div id="historyList"></div>
        </div>
    </div>
    <script>
        class TypingTest {
            constructor() {
                this.textos = {
                    facil: [
                        "El sol brilla en el cielo azul.",
                        "Me gusta tomar café por la mañana.",
                        "Hoy es un buen día para aprender."
                    ],
                    medio: [
                        "La tecnología avanza rápidamente, cambiando la forma en que vivimos cada día.",
                        "Aprender a programar puede abrir muchas puertas en el futuro profesional.",
                        "La lectura diaria mejora la concentración y la memoria de las personas."
                    ],
                    dificil: [
                        "La perseverancia es la clave del éxito.\nAunque enfrentes dificultades, nunca te rindas.\nCada error es una oportunidad para aprender y mejorar en la vida."
                    ]
                };
                this.textoOriginal = '';
                this.textoIngresado = '';
                this.inicio = null;
                this.fin = null;
                this.timer = null;
                this.isRunning = false;
                this.hasStarted = false;
                this.initializeElements();
                this.bindEvents();
            }
            initializeElements() {
                this.textDisplay = document.getElementById('textDisplay');
                this.textInput = document.getElementById('textInput');
                this.startBtn = document.getElementById('startBtn');
                this.resetBtn = document.getElementById('resetBtn');
                this.statsBtn = document.getElementById('statsBtn');
                this.results = document.getElementById('results');
                this.history = document.getElementById('history');
                this.historyList = document.getElementById('historyList');
                this.nombreInput = document.getElementById('nombreInput');
                this.nivelInput = document.getElementById('nivelInput');
                this.wpmElement = document.getElementById('wpm');
                this.precisionElement = document.getElementById('precision');
                this.tiempoElement = document.getElementById('tiempo');
                this.caracteresElement = document.getElementById('caracteres');
                this.finalWpm = document.getElementById('finalWpm');
                this.finalPrecision = document.getElementById('finalPrecision');
                this.finalTiempo = document.getElementById('finalTiempo');
                this.nivelActualSpan = document.getElementById('nivelActual');
                this.textoParaEscribirSpan = document.getElementById('textoParaEscribir');
            }
            bindEvents() {
                this.startBtn.addEventListener('click', () => this.prepareTest());
                this.resetBtn.addEventListener('click', () => this.reset());
                this.statsBtn.addEventListener('click', () => this.toggleHistory());
                this.textInput.addEventListener('input', (e) => this.handleInput(e));
            }
            prepareTest(nivelForzado) {
                this.nombre = this.nombreInput.value.trim();
                if (!this.nombre) {
                    alert('Por favor, ingresa tu nombre antes de comenzar.');
                    return;
                }
                this.niveles = ['facil', 'medio', 'dificil'];
                this.nivel = nivelForzado || this.nivelInput.value;
                // Actualizar el selector de nivel
                this.nivelInput.value = this.nivel;
                // Mostrar el nombre del nivel
                const nombresNiveles = {facil: 'Fácil', medio: 'Medio', dificil: 'Difícil'};
                this.nivelActualSpan.textContent = `Nivel: ${nombresNiveles[this.nivel]}`;
                const textosNivel = this.textos[this.nivel];
                this.textoOriginal = textosNivel[Math.floor(Math.random() * textosNivel.length)];
                this.displayText();
                this.textInput.value = '';
                this.textInput.disabled = false;
                this.textInput.focus();
                this.startBtn.disabled = true;
                this.isRunning = false;
                this.hasStarted = false;
                this.results.classList.remove('show');
            }
            displayText() {
                // Mostrar el nivel actual
                const nombresNiveles = {facil: 'Fácil', medio: 'Medio', dificil: 'Difícil'};
                this.nivelActualSpan.textContent = `Nivel: ${nombresNiveles[this.nivel]}`;
                // Procesar texto para saltos de línea y espacios
                let html = '';
                for (let i = 0; i < this.textoOriginal.length; i++) {
                    const char = this.textoOriginal[i];
                    if (char === '\n') {
                        html += '<br>';
                    } else if (char === ' ') {
                        html += '<span class="char">&nbsp;</span>';
                    } else {
                        html += `<span class="char">${char}</span>`;
                    }
                }
                this.textoParaEscribirSpan.innerHTML = html;
            }
            handleInput(e) {
                if (!this.hasStarted) {
                    this.inicio = Date.now();
                    this.isRunning = true;
                    this.hasStarted = true;
                    this.startTimer();
                }
                if (!this.isRunning) return;
                this.textoIngresado = e.target.value;
                this.updateDisplay();
                this.updateStats();
                if (this.textoIngresado.length >= this.textoOriginal.replace(/\n/g, '').length) {
                    this.finish();
                }
            }
            updateDisplay() {
                const chars = this.textoParaEscribirSpan.querySelectorAll('.char, br');
                const inputChars = this.textoIngresado.split('');
                let inputIndex = 0;
                chars.forEach((char, index) => {
                    // Si es salto de línea
                    if (char.tagName === 'BR') {
                        if (this.textoIngresado[inputIndex] === '\n') {
                            char.style.background = '#d4edda';
                            inputIndex++;
                        } else {
                            char.style.background = '#f8d7da';
                        }
                        return;
                    }
                    char.className = 'char';
                    if (inputIndex < inputChars.length) {
                        if (inputChars[inputIndex] === char.textContent || (char.textContent === '\u00A0' && inputChars[inputIndex] === ' ')) {
                            char.classList.add('correct');
                        } else {
                            char.classList.add('incorrect');
                        }
                    } else if (inputIndex === inputChars.length) {
                        char.classList.add('current');
                    }
                    inputIndex++;
                });
            }
            updateStats() {
                const tiempoTranscurrido = (Date.now() - this.inicio) / 1000;
                const palabras = this.textoIngresado.trim().split(/\s+/).length;
                const wpm = tiempoTranscurrido > 0 ? (palabras / tiempoTranscurrido) * 60 : 0;
                // Comparar incluyendo saltos de línea
                let correctos = 0;
                for (let i = 0; i < this.textoIngresado.length; i++) {
                    if (this.textoIngresado[i] === this.textoOriginal[i]) correctos++;
                }
                const precision = this.textoIngresado.length > 0 ? 
                    (correctos / this.textoIngresado.length) * 100 : 0;
                this.wpmElement.textContent = Math.round(wpm);
                this.precisionElement.textContent = Math.round(precision) + '%';
                this.tiempoElement.textContent = Math.round(tiempoTranscurrido) + 's';
                this.caracteresElement.textContent = this.textoIngresado.length;
            }
            startTimer() {
                this.timer = setInterval(() => {
                    if (this.isRunning) {
                        this.updateStats();
                    }
                }, 100);
            }
            async finish() {
                this.isRunning = false;
                this.fin = Date.now();
                clearInterval(this.timer);
                this.textInput.disabled = true;
                this.startBtn.disabled = false;
                const tiempoTotal = (this.fin - this.inicio) / 1000;
                const palabras = this.textoIngresado.trim().split(/\s+/).length;
                const wpm = (palabras / tiempoTotal) * 60;
                let caracteresCorrectos = 0;
                for (let i = 0; i < this.textoIngresado.length; i++) {
                    if (this.textoIngresado[i] === this.textoOriginal[i]) caracteresCorrectos++;
                }
                const precision = (caracteresCorrectos / this.textoIngresado.length) * 100;
                await this.saveResult(wpm, precision, tiempoTotal);
                // Avance automático de nivel o mensaje final
                const nivelActualIdx = this.niveles.indexOf(this.nivel);
                if (nivelActualIdx < this.niveles.length - 1) {
                    // Mostrar mensaje de avance
                    this.nivelActualSpan.textContent = '';
                    this.textoParaEscribirSpan.innerHTML = '<div style="width:100%;text-align:center;font-size:1.3em;color:#667eea;">¡Nivel completado! Avanzando al siguiente nivel...</div>';
                    setTimeout(() => {
                        this.prepareTest(this.niveles[nivelActualIdx + 1]);
                    }, 2000);
                } else {
                    // Mensaje de prueba terminada y resultados juntos y centrados
                    this.nivelActualSpan.textContent = '';
                    this.textoParaEscribirSpan.innerHTML = `
                        <div id="finalTestBox" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; min-height: 240px; height: 100%; margin: 0 auto;">
                            <div style="font-size:2.2em;color:#28a745;font-weight:bold;margin-bottom:28px;text-align:center;">Prueba terminada</div>
                            <div style="display: flex; gap: 40px; justify-content: center; align-items: center; margin-top: 10px;">
                                <div style='background:#f8f9fa;padding:24px 38px;border-radius:18px;text-align:center;box-shadow:0 2px 12px #0001; min-width: 140px;'>
                                    <div style='font-size:2.2em;font-weight:bold;color:#667eea;'>${Math.round(wpm)}</div>
                                    <div style='color:#666;font-size:1.1em;'>WPM Final</div>
                                </div>
                                <div style='background:#f8f9fa;padding:24px 38px;border-radius:18px;text-align:center;box-shadow:0 2px 12px #0001; min-width: 140px;'>
                                    <div style='font-size:2.2em;font-weight:bold;color:#667eea;'>${Math.round(precision)}%</div>
                                    <div style='color:#666;font-size:1.1em;'>Precisión Final</div>
                                </div>
                                <div style='background:#f8f9fa;padding:24px 38px;border-radius:18px;text-align:center;box-shadow:0 2px 12px #0001; min-width: 140px;'>
                                    <div style='font-size:2.2em;font-weight:bold;color:#667eea;'>${Math.round(tiempoTotal)}s</div>
                                    <div style='color:#666;font-size:1.1em;'>Tiempo Total</div>
                                </div>
                            </div>
                            <button id="continuarExcelBtn" style="margin-top: 32px; padding: 16px 36px; font-size: 1.2em; font-weight: bold; color: #fff; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; box-shadow: 0 2px 8px #0001; cursor: pointer; transition: background 0.2s;">Continuar prueba Excel</button>
                            <div id="excelImageBox" style="margin-top: 24px; display: none;"></div>
                        </div>
                    `;
                    // Agrega el evento al botón
                    setTimeout(() => {
                        const btn = document.getElementById('continuarExcelBtn');
                        if (btn) {
                            btn.onclick = () => {
                                window.open('/static/prueba_excel.xlsx', '_blank');
                                btn.disabled = true;
                                btn.style.opacity = '0.7';
                            };
                        }
                    }, 100);
                    // Oculta el bloque de resultados inferior si está visible
                    this.results.classList.remove('show');
                }
            }
            async saveResult(wpm, precision, tiempoTotal) {
                try {
                    await fetch('/api/guardar-resultado', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', },
                        body: JSON.stringify({
                            nombre: this.nombre,
                            wpm: wpm,
                            precision: precision,
                            tiempo_total: tiempoTotal,
                            texto_usado: this.textoOriginal,
                            nivel: this.nivel
                        })
                    });
                } catch (error) {
                    console.error('Error al guardar resultado:', error);
                }
            }
            showResults(wpm, precision, tiempoTotal) {
                this.finalWpm.textContent = Math.round(wpm);
                this.finalPrecision.textContent = Math.round(precision) + '%';
                this.finalTiempo.textContent = Math.round(tiempoTotal) + 's';
                this.results.classList.add('show');
            }
            reset() {
                this.isRunning = false;
                clearInterval(this.timer);
                this.textoOriginal = '';
                this.textoIngresado = '';
                this.inicio = null;
                this.fin = null;
                this.nivelActualSpan.textContent = '';
                this.textoParaEscribirSpan.textContent = 'Haz clic en "Comenzar" para iniciar el test de mecanografía';
                this.textInput.value = '';
                this.textInput.disabled = true;
                this.startBtn.disabled = false;
                this.wpmElement.textContent = '0';
                this.precisionElement.textContent = '0%';
                this.tiempoElement.textContent = '0s';
                this.caracteresElement.textContent = '0';
                this.results.classList.remove('show');
            }
            async toggleHistory() {
                if (this.history.style.display === 'none') {
                    await this.loadHistory();
                    this.history.style.display = 'block';
                    this.statsBtn.textContent = 'Ocultar Estadísticas';
                } else {
                    this.history.style.display = 'none';
                    this.statsBtn.textContent = 'Ver Estadísticas';
                }
            }
            async loadHistory() {
                try {
                    const response = await fetch('/api/estadisticas');
                    const data = await response.json();
                    this.historyList.innerHTML = data.resultados.length === 0 ? 
                        '<p>No hay resultados guardados aún.</p>' :
                        data.resultados.map(resultado => `
                            <div class="history-item">
                                <div>
                                    <span class="history-wpm">${Math.round(resultado.wpm)} WPM</span>
                                    <span class="history-precision">${Math.round(resultado.precision)}% precisión</span>
                                    <span class="history-nombre">${resultado.nombre ? resultado.nombre : ''}</span>
                                </div>
                                <div class="history-date">${resultado.fecha}</div>
                            </div>
                        `).join('');
                } catch (error) {
                    console.error('Error al cargar historial:', error);
                    this.historyList.innerHTML = '<p>Error al cargar el historial.</p>';
                }
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            new TypingTest();
        });
    </script>
</body>
</html> 